app-id: com.github.chipmuenk.pyfda
runtime: org.kde.Platform
runtime-version: 5.15-21.08
sdk: org.kde.Sdk
# when the runtime version changes, check if python version changed, because in pyqt5 the
# python version is hardcoded!
command: pyfdax
rename-icon: pyfda_icon #Image will renamed to match the app-id convention
rename-appdata-file: pyfda.appdata.xml
rename-desktop-file: pyfda.desktop
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --persist=.pyfda # so the configuration of different installations will not be overwritten

Parameters:
  git_url: &git_url https://github.com/chipmuenk/pyfda.git
  git_tag: &git_tag 59ff7e458db4fe1588df71e8c96fd8d3158db711

modules:
  - pyqt5.json

  - name: python3-packaging
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/fb/2b/9b9c33ffed44ee921d0967086d653047286054117d584f1b1a7c22ceaf7b/packaging-23.2.tar.gz
        sha256: 048fb0e9405036518eaaf48a55953c750c11e1a1b68e0dd1a9d62ed0c092cfc5
        x-checker-data:
          type: pypi
          name: packaging

  - name: python-flit-core
    buildsystem: simple
    build-commands:
      - pip3 install . --prefix=/app --no-index --find-links .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/c4/e6/c1ac50fe3eebb38a155155711e6e864e254ce4b6e17fe2429b4c4d5b9e80/flit_core-3.9.0.tar.gz
        sha256: 72ad266176c4a3fcfab5f2930d76896059851240570ce9a98733b658cb786eba
        x-checker-data:
          type: pypi
          name: flit_core

  - name: python-pyparsing
    buildsystem: simple
    build-commands:
      - pip3 install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} .
    cleanup:
      - '*'
    sources:
      - type: archive
        url: >-
          https://files.pythonhosted.org/packages/37/fe/65c989f70bd630b589adfbbcd6ed238af22319e90f059946c26b4835e44b/pyparsing-3.1.1.tar.gz
        sha256: ede28a1a32462f5a9705e07aea48001a08f7cf81a021585011deba701581a0db
        x-checker-data:
          type: pypi
          name: pyparsing

  - name: python-numpy
    buildsystem: simple
    build-commands:
      - rm pyproject.toml
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/55/b3/b13bce39ba82b7398c06d10446f5ffd5c07db39b09bd37370dc720c7951c/numpy-1.26.0.tar.gz
        sha256: f93fc78fe8bf15afe2b8d6b6499f1c73953169fad1e9a8dd086cdff3190e7fdf
        x-checker-data:
          type: pypi
          name: numpy

  - name: python-certifi # needed by matplotlib
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/98/98/c2ff18671db109c9f10ed27f5ef610ae05b73bd876664139cf95bd1429aa/certifi-2023.7.22.tar.gz
        sha256: 539cc1d13202e33ca466e88b2807e29f4c13049d6d87031a3c110744495cb082
        x-checker-data:
          type: pypi
          name: certifi

  - name: qhull # needed by matplotlib
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: http://www.qhull.org/download/qhull-2020-src-8.0.2.tgz
        sha256: b5c2d7eb833278881b952c8a52d20179eab87766b00b865000469a45c1838b7e

  - name: python-setuptools-scm
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/eb/b1/0248705f10f6de5eefe7ff93e399f7192257b23df4d431d2f5680bb2778f/setuptools-scm-8.0.4.tar.gz
        sha256: b5f43ff6800669595193fd09891564ee9d1d7dcb196cab4b2506d53a2e1c95c7
        x-checker-data:
          type: pypi
          name: setuptools-scm

  # needed by python-setuptools-scm-git-archive
  - name: python3-tomli
    buildsystem: simple
    build-commands:
      - >-
        pip3 install --verbose --exists-action=i --no-index
        --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "tomli"
        --no-build-isolation
    sources:
      - type: file
        url: >-
          https://files.pythonhosted.org/packages/75/50/973397c5ba854445bcc396b593b5db1958da6ab8d665b27397daa1497018/tomli-1.2.1.tar.gz
        sha256: a5b75cb6f3968abb47af1b40c1819dc519ea82bcc065776a866e8d74c5ca9442

  # needed by matplotlib      
  - name: python-typing-extensions
    buildsystem: simple
    build-commands:
      - >-
        pip3 install --verbose --exists-action=i --no-index
        --find-links=file://${PWD} --prefix=${FLATPAK_DEST} typing-extensions
        --no-build-isolation
    sources:
      - type: file
        url: >-
          https://files.pythonhosted.org/packages/24/21/7d397a4b7934ff4028987914ac1044d3b7d52712f30e2ac7a2ae5bc86dd0/typing_extensions-4.8.0-py3-none-any.whl
        sha256: 8f92fc8806f9a6b641eaa5318da32b44d401efaac0f6678c9bc448ba3605faa0
        x-checker-data:
          type: pypi
          name: typing-extensions
          packagetype: bdist_wheel

  - name: python-matplotlib
    buildsystem: simple
    build-options:
      env:
        MPLSETUPCFG: /run/build/python-matplotlib/matplotlib-setup.cfg
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: file
        path: matplotlib-setup.cfg
      - type: archive
        url: https://files.pythonhosted.org/packages/23/e1/77016194621fb1356aafeb2186f07b5dede62ea2043bf03f82325c4fccc5/matplotlib-3.8.0.tar.gz
        sha256: df8505e1c19d5c2c26aff3497a7cbd3ccfc2e97043d1e4db3e76afa399164b69
        x-checker-data:
          type: pypi
          name: matplotlib

  - name: python-cppy # needed by kiwisolver
    buildsystem: simple
    build-commands:
      - python3 -mpip  install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "cppy" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/31/5e/b8faf2b2aeb679c0f4359fd1a4716fe90d65f72f72639413ffb95f3c3b46/cppy-1.2.1-py3-none-any.whl
        sha256: c5b5eac3d3f42593a07d35275b0bc27f447b76b9ad8f27c62e3cfa286dc1988a


  - name: python-kiwisolver # needed by matplotlib
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/b9/2d/226779e405724344fc678fcc025b812587617ea1a48b9442628b688e85ea/kiwisolver-1.4.5.tar.gz
        sha256: e57e563a57fb22a142da34f38acc2fc1a5c864bc29ca1517a88abc963e60d6ec
        x-checker-data:
          type: pypi
          name: kiwisolver

  - name: python-numexpr # needed by pyfda
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/93/1d/b9e273d1509790e2add861895c872e797058fa408860f81716b11a09287f/numexpr-2.8.7.tar.gz
        sha256: 596eeb3bbfebc912f4b6eaaf842b61ba722cebdb8bc42dfefa657d3a74953849
        x-checker-data:
          type: pypi
          name: numexpr

  - name: python-markdown # needed by pyfda
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/87/2a/62841f4fb1fef5fa015ded48d02401cd95643ca03b6760b29437b62a04a4/Markdown-3.4.4.tar.gz
        sha256: 225c6123522495d4119a90b3a3ba31a1e87a70369e03f14799ea9c0d7183a3d6
        x-checker-data:
          type: pypi
          name: Markdown

  - name: python-mplcursors # needed by pyfda
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/03/ec/f28dd523e8397ae8c55878b802380aae7bfd65448f17e5c2b30927fe6575/mplcursors-0.5.2.tar.gz
        sha256: 78febb32adf2d9040e2f6fc84b5e4cfb8f96b4ede4916fc418e5fffbcfdc0957
        x-checker-data:
          type: pypi
          name: mplcursors

  - name: python-docutils # needed by pyfda
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/1f/53/a5da4f2c5739cf66290fac1431ee52aff6851c7c8ffd8264f13affd7bcdd/docutils-0.20.1.tar.gz
        sha256: f08a4e276c3a1583a86dce3e34aba3fe04d02bba2dd51ed16106244e8a923e3b
        x-checker-data:
          type: pypi
          name: docutils

  - name: python-xlwt # needed by pyfda
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/06/97/56a6f56ce44578a69343449aa5a0d98eefe04085d69da539f3034e2cd5c1/xlwt-1.3.0.tar.gz
        sha256: c59912717a9b28f1a3c2a98fd60741014b06b043936dcecbc113eaaada156c88
        x-checker-data:
          type: pypi
          name: xlwt

  # pyfda does not startup without
  - name: python3-Pillow
    buildsystem: simple
    build-commands:
      - >-
        pip3 install --verbose --exists-action=i --no-index
        --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "Pillow==9.0.1"
        --no-build-isolation
    sources:
      - type: file
        url: >-
          https://files.pythonhosted.org/packages/03/a3/f61a9a7ff7969cdef2a6e0383a346eb327495d20d25a2de5a088dbb543a6/Pillow-9.0.1.tar.gz
        sha256: 6c8bc8238a7dfdaf7a75f5ec5a663f4173f8c367e5a39f87e720495e1eed75fa

  - name: python-cycler # pyfda does not startup without
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/3f/22/13979b9dcef3296cae2e8d2b074be4d904ad36ec766d6fc0bb7cb4cbb258/cycler-0.12.0.tar.gz
        sha256: 8cc3a7b4861f91b1095157f9916f748549a617046e67eb7619abed9b34d2c94a
        x-checker-data:
          type: pypi
          name: cycler

  - name: python-dateutil # pyfda does not startup without
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/4c/c4/13b4776ea2d76c115c1d1b84579f3764ee6d57204f6be27119f13a61d0a9/python-dateutil-2.8.2.tar.gz
        sha256: 0123cacc1627ae19ddf3c27a5de5bd67ee4586fbdd6440d9748f8abb483d3e86
        x-checker-data:
          type: pypi
          name: python-dateutil

  - name: Eigen3 # needed by scipy
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.bz2
        sha256: b4c198460eba6f28d34894e3a5710998818515104d6e74e5cc331ce31e46e626
        x-checker-data:
          type: anitya
          project-id: 13751
          stable-only: true
          url-template: https://gitlab.com/libeigen/eigen/-/archive/$version/eigen-$version.tar.bz2
    cleanup:
      - '*'

  - name: lapack # needed by scipy
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DBUILD_TESTING=OFF
      - -DLAPACKE=ON
      - -DCBLAS=ON
    sources:
      - type: archive
        url: https://github.com/Reference-LAPACK/lapack/archive/refs/tags/v3.11.0.tar.gz
        sha256: 4b9ba79bfd4921ca820e83979db76ab3363155709444a787979e81c22285ffa9
        x-checker-data:
          type: anitya
          project-id: 1534
          stable-only: true
          url-template: https://github.com/Reference-LAPACK/lapack/archive/refs/tags/v$version.tar.gz
    cleanup:
      - /lib/cmake

  - name: pybind11 # needed by scipy
    buildsystem: simple
    build-commands:
      - python setup.py build
      - cmake -DPYBIND11_INSTALL=ON -DPYBIND11_TEST=OFF .
      - cmake --build .
      - python setup.py install --skip-build --force --prefix=/app
    sources:
      - type: archive
        url: https://github.com/pybind/pybind11/archive/v2.6.2.tar.gz
        sha256: 8ff2fff22df038f5cd02cea8af56622bc67f5b64534f1b83b9f133b8366acff2

  - name: python-scipy
    buildsystem: simple
    build-commands:
      - python3 setup.py build -j 8
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    build-options:
      env:
        ATLAS: None
        BLAS: /app/lib
        LAPACK: /app/lib
        LDFLAGS: -shared
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/39/7b/9f265b7f074195392e893a5cdc66116c2f7a31fd5f3d9cceff661ec6df82/scipy-1.11.3.tar.gz
        sha256: bba4d955f54edd61899776bad459bf7326e14b9fa1c552181f0479cc60a568cd
        x-checker-data:
          type: pypi
          name: scipy
    modules:
      - name: python-gast
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/e4/41/f26f62ebef1a80148e20951a6e9ef4d0ebbe2090124bc143da26e12a934c/gast-0.5.4.tar.gz
            sha256: 9c270fe5f4b130969b54174de7db4e764b09b4f7f67ccfc32480e29f78348d97
            x-checker-data:
              type: pypi
              name: gast

      # needed by scipy
      - name: python-pythran
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/2c/ab/a647b8cc3ac1aa07cde06875157696e4522958fb8363474bce21c302d4d8/pythran-0.14.0.tar.gz
            sha256: 42f3473946205964844eff7f750e2541afb2006d53475d708f5ff2d048db89bd
            x-checker-data:
              type: pypi
              name: pythran

      - name: python-beniget
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/14/e7/50cbac38f77eca8efd39516be6651fdb9f3c4c0fab8cf2cf05f612578737/beniget-0.4.1.tar.gz
            sha256: 75554b3b8ad0553ce2f607627dad3d95c60c441189875b98e097528f8e23ac0c
            x-checker-data:
              type: pypi
              name: beniget

      - name: python-ply
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/e5/69/882ee5c9d017149285cab114ebeab373308ef0f874fcdac9beb90e0ac4da/ply-3.11.tar.gz
            sha256: 00c7c1aaa88358b9c765b6d3000c6eec0ba42abca5351b095321aef446081da3
            x-checker-data:
              type: pypi
              name: ply

  - name: pyfda
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
      - desktop-file-install --dir=/app/share/applications ressource/mime/applications/pyfda.desktop
      - install -Dm755 ressource/linux/pyfda.appdata.xml /app/share/appdata/pyfda.appdata.xml
      - install -Dm755 pyfda/images/icons/pyfda_icon_16.png /app/share/icons/hicolor/16x16/apps/pyfda_icon.png
      - install -Dm755 pyfda/images/icons/pyfda_icon_32.png /app/share/icons/hicolor/32x32/apps/pyfda_icon.png
      - install -Dm755 pyfda/images/icons/pyfda_icon_64.png /app/share/icons/hicolor/64x64/apps/pyfda_icon.png
      - install -Dm755 pyfda/images/icons/pyfda_icon_128.png /app/share/icons/hicolor/128x128/apps/pyfda_icon.png
      - install -Dm755 pyfda/images/icons/pyfda_icon_256.png /app/share/icons/hicolor/256x256/apps/pyfda_icon.png
      - install -Dm755 pyfda/images/icons/pyfda_icon.svg /app/share/icons/hicolor/scalable/apps/pyfda_icon.svg
    sources:
      - type: git
        url: *git_url
        tag: *git_tag
