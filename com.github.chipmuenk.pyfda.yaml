app-id: com.github.chipmuenk.pyfda
runtime: org.kde.Platform
runtime-version: 5.15-21.08
sdk: org.kde.Sdk
# when the runtime version changes, check if python version changed, because in pyqt5 the
# python version is hardcoded!
command: pyfdax
rename-icon: pyfda_icon #Image will renamed to match the app-id convention
rename-appdata-file: pyfda.appdata.xml
rename-desktop-file: pyfda.desktop
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --persist=.pyfda # so the configuration of different installations will not be overwritten
modules:
  - pyqt5.json

  - name: python3-packaging
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/df/9e/d1a7217f69310c1db8fdf8ab396229f55a699ce34a203691794c5d1cad0c/packaging-21.3.tar.gz
        sha256: dd47c42927d89ab911e606518907cc2d3a1f38bbd026385970643f9c5b8ecfeb
        x-checker-data:
          type: pypi
          name: packaging
      #- type: patch
        #path: relax-dependencies.patch

  - name: python-pyparsing
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/71/22/207523d16464c40a0310d2d4d8926daffa00ac1f5b1576170a32db749636/pyparsing-3.0.9.tar.gz
        sha256: 2b020ecf7d21b687f219b71ecad3631f644a47f01403fa1d1036b0c6416d70fb
        x-checker-data:
          type: pypi
          name: pyparsing

  - name: python-numpy
    buildsystem: simple
    build-commands:
      - rm pyproject.toml
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/0a/88/f4f0c7a982efdf7bf22f283acf6009b29a9cc5835b684a49f8d3a4adb22f/numpy-1.23.3.tar.gz
        sha256: 51bf49c0cd1d52be0a240aa66f3458afc4b95d8993d2d04f0d91fa60c10af6cd
        x-checker-data:
          type: pypi
          name: numpy

  - name: python-certifi # needed by matplotlib
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/cb/a4/7de7cd59e429bd0ee6521ba58a75adaec136d32f91a761b28a11d8088d44/certifi-2022.9.24.tar.gz
        sha256: 0d9c601124e5a6ba9712dbc60d9c53c21e34f5f641fe83002317394311bdce14
        x-checker-data:
          type: pypi
          name: certifi

  - name: qhull # needed by matplotlib
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: http://www.qhull.org/download/qhull-2020-src-8.0.2.tgz
        sha256: b5c2d7eb833278881b952c8a52d20179eab87766b00b865000469a45c1838b7e

  - name: python-setuptools-scm
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/d0/43/f038b5009f93bcd77b1b8da9e6d424b739ab17aec9726f3a99eba23d53ca/setuptools_scm-7.0.5.tar.gz
        sha256: 031e13af771d6f892b941adb6ea04545bbf91ebc5ce68c78aaf3fff6e1fb4844
        x-checker-data:
          type: pypi
          name: setuptools-scm

  - name: python-flit-core
    buildsystem: simple
    build-commands:
      - pip3 install . --prefix=/app --no-index --find-links .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/15/d1/d8798b83e953fd6f86ca9b50f93eec464a9305b0661469c8234e61095481/flit_core-3.7.1.tar.gz
        sha256: 14955af340c43035dbfa96b5ee47407e377ee337f69e70f73064940d27d0a44f
        x-checker-data:
          type: pypi
          name: flit_core

  - python3-tomli.json # needed by python-setuptools-scm-git-archive     
  - name: python-setuptools-scm-git-archive # needed by matplotlib
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/69/5f/7135eec07395c51d3dd6899251b277405ecc2f8f7a80ef80a483e3c5a2bd/setuptools_scm_git_archive-1.4.tar.gz
        sha256: b048b27b32e1e76ec865b0caa4bb85df6ddbf4697d6909f567ac36709f6ef2f0
        x-checker-data:
          type: pypi
          name: setuptools-scm-git-archive

  - name: python-matplotlib
    buildsystem: simple
    build-options:
      env:
        MPLSETUPCFG: /run/build/python-matplotlib/matplotlib-setup.cfg
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: file
        path: matplotlib-setup.cfg
      - type: archive
        url: https://files.pythonhosted.org/packages/69/e6/c36374904b757c8193a44af789ddf5bc27f2fe5fbd0cdd908f09cb21e2e1/matplotlib-3.6.0.tar.gz
        sha256: c5108ebe67da60a9204497d8d403316228deb52b550388190c53a57394d41531
        x-checker-data:
          type: pypi
          name: matplotlib

  - name: python-cppy # needed by kiwisolver
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/c5/7e/6cc5acd93752ee52d2f0423046072a2ce3ae16dfcd44373b9fe2a0222204/cppy-1.2.1.tar.gz
        sha256: 83b43bf17b1085ac15c5debdb42154f138b928234b21447358981f69d0d6fe1b
        x-checker-data:
          type: pypi
          name: cppy

  - name: python-kiwisolver # needed by matplotlib
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/5f/5c/272a7dd49a1914f35cd8d6d9f386defa8b047f6fbd06badd6b77b3ba24e7/kiwisolver-1.4.4.tar.gz
        sha256: d41997519fcba4a1e46eb4a2fe31bc12f0ff957b2b81bac28db24744f333e955
        x-checker-data:
          type: pypi
          name: kiwisolver

  - name: python-numexpr # needed by pyfda
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/b2/52/79f6b7db72b4cb847006d915801cc423c6b57e794c3802cfda648a4c6321/numexpr-2.8.3.tar.gz
        sha256: cb647c9d9c785dae0759bf6c875cde2bec472b5c3f7a6015734b161ae766d141
        x-checker-data:
          type: pypi
          name: numexpr

  - name: python-markdown # needed by pyfda
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/85/7e/133e943e97a943d2f1d8bae0c5060f8ac50e6691754eb9dbe036b047a9bb/Markdown-3.4.1.tar.gz
        sha256: 3b809086bb6efad416156e00a0da66fe47618a5d6918dd688f53f40c8e4cfeff
        x-checker-data:
          type: pypi
          name: Markdown

  - name: python-mplcursors # needed by pyfda
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/93/d1/ff80fd8a5d7c2bb9ef9968bbffdb65445bec990c427d55899af22900f57d/mplcursors-0.5.1.tar.gz
        sha256: d52bc6e6c68371937dcf147d29ddd396f64a610663af006ef9145055bd2dcc84
        x-checker-data:
          type: pypi
          name: mplcursors

  - name: python-docutils # needed by pyfda
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/6b/5c/330ea8d383eb2ce973df34d1239b3b21e91cd8c865d21ff82902d952f91f/docutils-0.19.tar.gz
        sha256: 33995a6753c30b7f577febfc2c50411fec6aac7f7ffeb7c4cfe5991072dcf9e6
        x-checker-data:
          type: pypi
          name: docutils

  - name: python-xlwt # needed by pyfda
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/06/97/56a6f56ce44578a69343449aa5a0d98eefe04085d69da539f3034e2cd5c1/xlwt-1.3.0.tar.gz
        sha256: c59912717a9b28f1a3c2a98fd60741014b06b043936dcecbc113eaaada156c88
        x-checker-data:
          type: pypi
          name: xlwt

  - python3-Pillow.json   # pyfda does not startup without
  - name: python-cycler # pyfda does not startup without
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/34/45/a7caaacbfc2fa60bee42effc4bcc7d7c6dbe9c349500e04f65a861c15eb9/cycler-0.11.0.tar.gz
        sha256: 9c87405839a19696e837b3b818fed3f5f69f16f1eec1a1ad77e043dcea9c772f
        x-checker-data:
          type: pypi
          name: cycler

  - name: python-dateutil # pyfda does not startup without
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/4c/c4/13b4776ea2d76c115c1d1b84579f3764ee6d57204f6be27119f13a61d0a9/python-dateutil-2.8.2.tar.gz
        sha256: 0123cacc1627ae19ddf3c27a5de5bd67ee4586fbdd6440d9748f8abb483d3e86
        x-checker-data:
          type: pypi
          name: python-dateutil

  - name: Eigen3 # needed by scipy
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.bz2
        sha256: b4c198460eba6f28d34894e3a5710998818515104d6e74e5cc331ce31e46e626
        x-checker-data:
          type: anitya
          project-id: 13751
          stable-only: true
          url-template: https://gitlab.com/libeigen/eigen/-/archive/$version/eigen-$version.tar.bz2
    cleanup:
      - '*'

  - name: lapack # needed by scipy
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DBUILD_TESTING=OFF
      - -DLAPACKE=ON
      - -DCBLAS=ON
    sources:
      - type: archive
        url: https://github.com/Reference-LAPACK/lapack/archive/refs/tags/v3.10.1.tar.gz
        sha256: cd005cd021f144d7d5f7f33c943942db9f03a28d110d6a3b80d718a295f7f714
        x-checker-data:
          type: anitya
          project-id: 1534
          stable-only: true
          url-template: https://github.com/Reference-LAPACK/lapack/archive/refs/tags/v$version.tar.gz
    cleanup:
      - /lib/cmake

  - name: pybind11 # needed by scipy
    buildsystem: simple
    build-commands:
      - python setup.py build
      - cmake -DPYBIND11_INSTALL=ON -DPYBIND11_TEST=OFF .
      - cmake --build .
      - python setup.py install --skip-build --force --prefix=/app
    sources:
      - type: archive
        url: https://github.com/pybind/pybind11/archive/v2.6.2.tar.gz
        sha256: 8ff2fff22df038f5cd02cea8af56622bc67f5b64534f1b83b9f133b8366acff2

  - name: python-scipy
    buildsystem: simple
    build-commands:
      - python3 setup.py build -j 8
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    build-options:
      env:
        ATLAS: None
        BLAS: /app/lib
        LAPACK: /app/lib
        LDFLAGS: -shared
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/db/af/16906139f52bc6866c43401869ce247662739ad71afa11c6f18505eb0546/scipy-1.9.1.tar.gz
        sha256: 26d28c468900e6d5fdb37d2812ab46db0ccd22c63baa095057871faa3a498bc9
        x-checker-data:
          type: pypi
          name: scipy
    modules:
      - name: python-gast
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/48/a3/0bd844c54ae8141642088b7ae09dd38fec2ec7faa9b7d25bb6a23c1f266f/gast-0.5.3.tar.gz
            sha256: cfbea25820e653af9c7d1807f659ce0a0a9c64f2439421a7bba4f0983f532dea
            x-checker-data:
              type: pypi
              name: gast
      - name: python-pythran
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/c6/e6/986a967dcca91d89e36f4d4a2f69a052030bce01a7cd48a6b7fba1a50189/pythran-0.9.12.post1.tar.gz
            sha256: e7589cf83b0befa9a1b55e98223caf89aff887d9e3f14be912cf8703a717f185
          - type: patch
            path: remove_pytest-runner.patch
            x-checker-data:
              type: pypi
              name: pythran
      - name: python-beniget
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/14/e7/50cbac38f77eca8efd39516be6651fdb9f3c4c0fab8cf2cf05f612578737/beniget-0.4.1.tar.gz
            sha256: 75554b3b8ad0553ce2f607627dad3d95c60c441189875b98e097528f8e23ac0c
            x-checker-data:
              type: pypi
              name: beniget
      - name: python-ply
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/e5/69/882ee5c9d017149285cab114ebeab373308ef0f874fcdac9beb90e0ac4da/ply-3.11.tar.gz
            sha256: 00c7c1aaa88358b9c765b6d3000c6eec0ba42abca5351b095321aef446081da3
            x-checker-data:
              type: pypi
              name: ply

  - name: pyfda
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
      - desktop-file-install --dir=/app/share/applications ressource/mime/applications/pyfda.desktop
      - install -Dm755 ressource/linux/pyfda.appdata.xml /app/share/appdata/pyfda.appdata.xml
      - install -Dm755 pyfda/images/icons/pyfda_icon_16.png /app/share/icons/hicolor/16x16/apps/pyfda_icon.png
      - install -Dm755 pyfda/images/icons/pyfda_icon_32.png /app/share/icons/hicolor/32x32/apps/pyfda_icon.png
      - install -Dm755 pyfda/images/icons/pyfda_icon_64.png /app/share/icons/hicolor/64x64/apps/pyfda_icon.png
      - install -Dm755 pyfda/images/icons/pyfda_icon_128.png /app/share/icons/hicolor/128x128/apps/pyfda_icon.png
      - install -Dm755 pyfda/images/icons/pyfda_icon_256.png /app/share/icons/hicolor/256x256/apps/pyfda_icon.png
      - install -Dm755 pyfda/images/icons/pyfda_icon.svg /app/share/icons/hicolor/scalable/apps/pyfda_icon.svg
    sources:
      - type: git
        url: https://github.com/chipmuenk/pyfda.git
        commit: 5634b05fffb8b04791b7846a6cc7da195456a90d
